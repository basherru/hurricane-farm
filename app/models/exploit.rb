class Exploit < ApplicationRecord
  has_and_belongs_to_many :teams
  has_many :flags

  validates :source, :period, :timeout, :title, presence: true

  enum status: %i[active inactive]

  scope :temporal_statistics_flags, ->() do
    all.map do |exploit|
      {
        name: exploit.title || 'Unknown',
        data: Flag.group_by_minutes(10, aggregation: { type: :count, field: '1' }, where_clause: { exploit_id: exploit.id }).first(10).to_h
      }
    end
  end

  scope :temporal_statistics_points, ->() do
    all.map do |exploit|
      {
        name: exploit.title || 'Unknown',
        data: Flag.group_by_minutes(10, aggregation: { type: :sum, field: :pts }, where_clause: { exploit_id: exploit.id }).first(10).to_h
      }
    end
  end
end
