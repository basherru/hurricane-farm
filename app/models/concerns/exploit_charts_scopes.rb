module ExploitChartsScopes
  extend ActiveSupport::Concern

  included do
    scope :temporal_flags, ->() do
      all.map do |exploit|
        {
          name: exploit.title || 'Unknown',
          data: Flag.group_by_minutes(10, aggregation: { type: :count, field: '1' }, where_clause: { exploit_id: exploit.id }).first(10).to_h
        }
      end
    end

    scope :temporal_points, ->() do
      all.map do |exploit|
        {
          name: exploit.title || 'Unknown',
          data: Flag.group_by_minutes(10, aggregation: { type: :sum, field: :pts }, where_clause: { exploit_id: exploit.id }).first(10).to_h
        }
      end
    end

    scope :flags_partition, ->() do
      Flag.joins(:exploit).group(:title).order('count(1) desc').count.first(10).to_h
    end

    scope :points_partition, ->() do
      Flag.joins(:exploit).group(:title).order('sum(pts) desc').sum(:pts).first(10).to_h
    end
  end
end