# frozen_string_literal: true

class ExploitDatatable < ApplicationDatatable
  def view_columns
    @view_columns ||= {
      id: { source: "Exploit.id" },
      title: { source: "Exploit.title" },
      period: { source: "Exploit.period" },
      timeout: { source: "Exploit.timeout" },
      flags: { orderable: false, searchable: false },
      points: { orderable: false, searchable: false },
      status: { source: "Exploit.status" },
      edit_link: { orderable: false, searchable: false },
    }
  end

  def data
    records.map do |record|
      {
        id: record.id,
        title: record.title,
        period: record.period,
        timeout: record.timeout,
        flags: query_to_line_chart(flags_query_for(record)),
        points: query_to_line_chart(points_query_for(record)),
        status: record.status,
        edit_link: edit_exploit_path(record),
      }
    end
  end

  def get_raw_records
    Exploit.all
  end

  def flags_query_for(record)
    Queries::GroupByMinutes.call(
      :flags,
      aggregation: { function: :count, column: "1" },
      conditions: { exploit_id: record.id },
    ).response
  end

  def points_query_for(record)
    Queries::GroupByMinutes.call(
      :flags,
      aggregation: { function: :sum, column: :pts },
      conditions: { exploit_id: record.id },
    ).response
  end
end
