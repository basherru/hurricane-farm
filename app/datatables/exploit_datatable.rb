class ExploitDatatable < AjaxDatatablesRails::ActiveRecord
  include Chartkick::Helper
  include Rails.application.routes.url_helpers

  def view_columns
    @view_columns ||= {
      id:        { source: "Exploit.id" },
      title:     { source: "Exploit.title" },
      period:    { source: "Exploit.period" },
      timeout:   { source: "Exploit.timeout" },
      flags:     { orderable: false, searchable: false },
      points:    { orderable: false, searchable: false },
      status:    { source: "Exploit.status" },
      edit_link: { orderable: false, searchable: false }
    }
  end

  def data
    records.map do |record|
      {
        id:        record.id,
        title:     record.title,
        period:    record.period,
        timeout:    record.timeout,
        flags:     line_chart(flags_chart_data(record)),
        points:    line_chart(points_chart_data(record)),
        status:    record.status,
        edit_link: edit_exploit_path(record)
      }
    end
  end

  def get_raw_records
    Exploit
  end

  def flags_chart_data(record)
    Flag
      .group_by_minutes(1, aggregation: { type: :count, field: '1' }, where_clause: { exploit_id: record.id })
      .first(10)
      .to_h
  end

  def points_chart_data(record)
    Flag
      .group_by_minutes(1, aggregation: { type: :sum, field: :pts }, where_clause: { exploit_id: record.id })
      .first(10)
      .to_h
  end
end
