# frozen_string_literal: true

class Engine::Exploit::AfterSave < ApplicationService
  struct :exploit
  attr_accessor :scheduler_handle

  def call
    success! process!
  end

  private

  def process!
    unshedule!
    schedule!
    update_handle!
  end

  def unshedule!
    return if exploit.scheduler_handle?

    Engine::Exploit::Unschedule.call(exploit)
  end

  def schedule!
    return if exploit.down?

    self.scheduler_handle = Engine::Exploit::Schedule.call(self).response
  end

  def update_handle!
    exploit.update_columns(scheduler_handle: scheduler_handle)
  end
end
